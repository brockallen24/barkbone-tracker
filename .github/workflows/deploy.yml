name: Deploy to Heroku

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set Heroku config vars and deploy
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
          HEROKU_APP_NAME: ${{ secrets.HEROKU_APP_NAME }}
          AIRTABLE_API_KEY: ${{ secrets.AIRTABLE_API_KEY }}
          AIRTABLE_BASE_ID: ${{ secrets.AIRTABLE_BASE_ID }}
          AIRTABLE_TABLE_ID: ${{ secrets.AIRTABLE_TABLE_ID }}
        run: |
          # Set Heroku environment variables
          curl -X PATCH https://api.heroku.com/apps/${HEROKU_APP_NAME}/config-vars \
            -H "Accept: application/vnd.heroku+json; version=3" \
            -H "Authorization: Bearer ${HEROKU_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "{\"AIRTABLE_API_KEY\":\"${AIRTABLE_API_KEY}\",\"AIRTABLE_BASE_ID\":\"${AIRTABLE_BASE_ID}\",\"AIRTABLE_TABLE_ID\":\"${AIRTABLE_TABLE_ID}\"}"

          # Deploy to Heroku
          git remote add heroku https://heroku:${HEROKU_API_KEY}@git.heroku.com/${HEROKU_APP_NAME}.git || true
          git push heroku HEAD:main --force
