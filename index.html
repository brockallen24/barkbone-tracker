<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 30px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2.5em;
            text-align: center;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .sync-status {
            text-align: center;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
            margin-bottom: 15px;
        }

        .sync-status.connected {
            background: #c6f6d5;
            color: #22543d;
        }

        .sync-status.syncing {
            background: #fef3c7;
            color: #92400e;
        }

        .sync-status.error {
            background: #fed7d7;
            color: #c53030;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #48bb78;
            color: white;
            margin-left: 10px;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #38a169;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(72, 187, 120, 0.4);
        }

        .btn-danger {
            background: #f56565;
            color: white;
            margin-left: 10px;
        }

        .btn-danger:hover:not(:disabled) {
            background: #e53e3e;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245, 101, 101, 0.4);
        }

        .product-list {
            background: #fff;
            border-radius: 10px;
        }

        .product-header {
            display: grid;
            grid-template-columns: 40px 40px 1fr 2fr 100px 120px 100px 120px 120px 120px 150px;
            gap: 10px;
            padding: 15px 20px;
            background: #667eea;
            color: white;
            font-weight: 600;
            border-radius: 10px 10px 0 0;
            font-size: 14px;
        }

        .product-row {
            display: grid;
            grid-template-columns: 40px 40px 1fr 2fr 100px 120px 100px 120px 120px 120px 150px;
            gap: 10px;
            padding: 20px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: move;
            transition: all 0.3s ease;
            align-items: center;
        }

        .product-row:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
            border-color: #667eea;
        }

        .product-row.dragging {
            opacity: 0.5;
            transform: scale(0.98);
        }

        .product-row.drag-over {
            border-color: #48bb78;
            border-style: dashed;
            background: #f0fff4;
        }

        .drag-handle {
            font-size: 24px;
            color: #a0aec0;
            cursor: grab;
            user-select: none;
            text-align: center;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        .product-field {
            font-size: 14px;
            color: #2d3748;
            word-wrap: break-word;
        }

        .delete-btn {
            background: #fc8181;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
            margin-left: 5px;
        }

        .delete-btn:hover {
            background: #f56565;
            transform: scale(1.05);
        }

        .edit-btn {
            background: #4299e1;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .edit-btn:hover {
            background: #3182ce;
            transform: scale(1.05);
        }

        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .priority-toggle {
            background: none;
            border: 2px solid #667eea;
            color: #667eea;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .priority-toggle:hover {
            background: #667eea;
            color: white;
            transform: scale(1.05);
        }

        .priority-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .priority-critical {
            background: #fc8181;
            color: white;
        }

        .priority-high {
            background: #f6ad55;
            color: white;
        }

        .priority-medium {
            background: #f6e05e;
            color: #744210;
        }

        .priority-low {
            background: #68d391;
            color: white;
        }

        .priority-none {
            background: #e2e8f0;
            color: #4a5568;
        }

        .part-number-cell {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .part-number-text {
            font-weight: 700;
            padding: 6px 10px;
            border-radius: 4px;
            display: inline-block;
        }

        .backer-status {
            font-weight: 700;
            padding: 6px 10px;
            border-radius: 4px;
            display: inline-block;
        }

        .status-positive {
            background: #c6f6d5;
            color: #22543d;
        }

        .status-negative {
            background: #fc8181;
            color: white;
        }

        .status-zero {
            background: #e2e8f0;
            color: #4a5568;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 32px;
            font-weight: bold;
            line-height: 20px;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .close:hover {
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #a0aec0;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .loading-state {
            text-align: center;
            padding: 60px 20px;
            color: #667eea;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .history-container {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .history-item {
            padding: 12px;
            background: white;
            border-left: 4px solid #667eea;
            margin-bottom: 10px;
            border-radius: 4px;
            font-size: 14px;
        }

        .history-item.edit {
            border-left-color: #4299e1;
        }

        .history-item.delete {
            border-left-color: #f56565;
        }

        .history-item.inventory {
            border-left-color: #48bb78;
        }

        .history-item.shipment {
            border-left-color: #ed8936;
        }

        .history-timestamp {
            color: #a0aec0;
            font-size: 12px;
            margin-left: 10px;
        }

        @media (max-width: 1200px) {
            .product-header,
            .product-row {
                grid-template-columns: 40px 35px 100px 150px 80px 100px 80px 100px 100px 100px 120px;
                font-size: 12px;
            }
        }

        @media (max-width: 768px) {
            .product-header,
            .product-row {
                grid-template-columns: 1fr;
                gap: 5px;
            }

            .product-header > span {
                display: none;
            }

            .product-field::before {
                content: attr(data-label);
                font-weight: 600;
                display: inline-block;
                width: 120px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì¶ Inventory Tracker <small style="font-size: 12px; color: #a0aec0;">v2.1</small></h1>
        <div class="subtitle">
            <span id="syncStatus" class="sync-status connected">Connected to Cloud</span>
            <span style="margin-left: 20px;">
                üë§ Operator: <input type="text" id="operatorName" placeholder="Enter your name"
                    style="padding: 5px 10px; border: 1px solid #e2e8f0; border-radius: 5px; font-size: 14px; width: 150px;"
                    onchange="saveOperatorName(this.value)">
            </span>
        </div>

        <!-- Toast notification for feedback -->
        <div id="toast" style="display: none; position: fixed; top: 20px; right: 20px; background: #48bb78; color: white; padding: 15px 25px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 9999; font-weight: 600;"></div>

        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-label">Total Products</div>
                <div class="stat-value" id="totalProducts">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Critical Priority</div>
                <div class="stat-value" id="criticalCount">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">High Priority</div>
                <div class="stat-value" id="highCount">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Open PO</div>
                <div class="stat-value" id="totalOpenPO">0</div>
            </div>
        </div>

        <div class="controls">
            <div>
                <button class="btn btn-primary" onclick="openModal()">‚ûï Add New Product</button>
                <button class="btn btn-secondary" onclick="refreshData()">üîÑ Refresh</button>
                <button class="btn btn-secondary" onclick="openInventoryModal()">üì• Receive Inventory</button>
                <button class="btn btn-secondary" onclick="openShipmentModal()">üì§ Process Shipment</button>
                <button class="btn btn-secondary" onclick="generatePDF()">üìÑ Export PDF</button>
            </div>
            <div>
                <button class="btn btn-danger" onclick="confirmDeleteAll()">üóëÔ∏è Delete All</button>
            </div>
        </div>

        <div class="product-list">
            <div class="product-header">
                <span>‚†ø</span>
                <span>#</span>
                <span>Part Number</span>
                <span>Description</span>
                <span>Priority</span>
                <span>Open PO</span>
                <span>Box Size</span>
                <span>Case Pack</span>
                <span>Backer Stock</span>
                <span>Backer Status</span>
                <span>Amount Needed</span>
                <span>Actions</span>
            </div>
            <div id="productContainer">
                <div class="loading-state">
                    <div class="loading-spinner"></div>
                    <div>Loading products...</div>
                </div>
            </div>
        </div>

        <div class="history-container">
            <h3 style="margin-bottom: 15px; color: #333;">üìä Recent Activity</h3>
            <div id="historyContainer"></div>
        </div>
    </div>

    <!-- Add/Edit Product Modal -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2 id="modalTitle" style="margin-bottom: 20px; color: #333;">Add New Product</h2>
            <form id="productForm">
                <div class="form-group">
                    <label for="partNumber">Part Number *</label>
                    <input type="text" id="partNumber" required>
                </div>
                <div class="form-group">
                    <label for="description">Description *</label>
                    <textarea id="description" required></textarea>
                </div>
                <div class="form-group">
                    <label for="priority">Priority</label>
                    <select id="priority">
                        <option value="none">None</option>
                        <option value="low">Low</option>
                        <option value="medium">Medium</option>
                        <option value="high">High</option>
                        <option value="critical">Critical</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="openPO">Open PO</label>
                    <input type="number" id="openPO" min="0">
                </div>
                <div class="form-group">
                    <label for="boxSize">Box Size</label>
                    <input type="text" id="boxSize" placeholder="e.g., 12x6x6">
                </div>
                <div class="form-group">
                    <label for="casePack">Case Pack</label>
                    <input type="number" id="casePack" min="0">
                </div>
                <div class="form-group">
                    <label for="backerStock">Backer Stock</label>
                    <input type="number" id="backerStock" min="0">
                </div>
                <div class="form-group">
                    <label for="amountNeeded">Amount Needed</label>
                    <input type="number" id="amountNeeded" min="0">
                </div>
                <button type="submit" id="submitBtn" class="btn btn-primary" style="width: 100%;">Add Product</button>
            </form>
        </div>
    </div>

    <!-- Receive Inventory Modal -->
    <div id="inventoryModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeInventoryModal()">&times;</span>
            <h2 style="margin-bottom: 20px; color: #333;">üì• Receive Inventory</h2>
            <form id="inventoryForm">
                <div class="form-group">
                    <label for="inventoryProduct">Select Product *</label>
                    <select id="inventoryProduct" required>
                        <option value="">-- Select a product --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="inventoryQuantity">Quantity Received *</label>
                    <input type="number" id="inventoryQuantity" min="1" required>
                </div>
                <div class="form-group">
                    <label for="inventoryDate">Date Received</label>
                    <input type="date" id="inventoryDate">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Receive Inventory</button>
            </form>
        </div>
    </div>

    <!-- Process Shipment Modal -->
    <div id="shipmentModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeShipmentModal()">&times;</span>
            <h2 style="margin-bottom: 20px; color: #333;">üì§ Process Shipment</h2>
            <form id="shipmentForm">
                <div class="form-group">
                    <label for="shipmentProduct">Select Product *</label>
                    <select id="shipmentProduct" required>
                        <option value="">-- Select a product --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="shipmentQuantity">Quantity Shipped *</label>
                    <input type="number" id="shipmentQuantity" min="1" required>
                </div>
                <div class="form-group">
                    <label for="shipmentDate">Shipment Date</label>
                    <input type="date" id="shipmentDate">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Process Shipment</button>
            </form>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        // ============================================
        // AIRTABLE CONFIGURATION (loaded from config.js)
        // ============================================

        const AIRTABLE_URL = `https://api.airtable.com/v0/${AIRTABLE_CONFIG.baseId}/${AIRTABLE_CONFIG.tableId}`;

        // ============================================
        // STATE
        // ============================================
        let products = [];
        let draggedElement = null;
        let editingProductId = null;
        let history = [];

        const priorityOrder = ['none', 'low', 'medium', 'high', 'critical'];

        // ============================================
        // ORDER PERSISTENCE (saved to Airtable)
        // ============================================

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.style.background = isError ? '#f56565' : '#48bb78';
            toast.style.display = 'block';
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }

        async function saveProductOrderToAirtable() {
            // Update SortOrder for all products in Airtable
            // Airtable allows max 10 records per batch update
            setSyncStatus('syncing');

            try {
                const updates = products.map((product, index) => ({
                    id: product.id,
                    fields: { SortOrder: index }
                }));

                // Batch updates in groups of 10 (Airtable limit)
                for (let i = 0; i < updates.length; i += 10) {
                    const batch = updates.slice(i, i + 10);
                    const response = await fetch(AIRTABLE_URL, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${AIRTABLE_CONFIG.apiKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ records: batch })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error('Airtable error:', errorData);

                        // Check if error is due to missing SortOrder field
                        const errorMessage = JSON.stringify(errorData).toLowerCase();
                        if (errorMessage.includes('unknown_field_name') ||
                            errorMessage.includes('sortorder') ||
                            errorMessage.includes('unknown field')) {
                            throw new Error('MISSING_SORTORDER_FIELD');
                        }
                        throw new Error('Failed to save product order');
                    }
                }

                // Add history entry for reorder
                addHistory('reorder', 'Product order updated');
                renderHistory();

                setSyncStatus('connected');
                showToast('‚úì Order saved!');
            } catch (error) {
                console.error('Error saving product order:', error);
                setSyncStatus('error');

                if (error.message === 'MISSING_SORTORDER_FIELD') {
                    showToast('‚úó Missing SortOrder field in Airtable!', true);
                    alert(
                        'To enable drag-and-drop reordering, please add a "SortOrder" field to your Airtable:\n\n' +
                        '1. Open your Airtable base\n' +
                        '2. Click the "+" button to add a new field\n' +
                        '3. Name it exactly: SortOrder\n' +
                        '4. Set the field type to: Number\n' +
                        '5. Save and refresh this page\n\n' +
                        'Your current order is preserved in this session.'
                    );
                } else {
                    showToast('‚úó Failed to save order!', true);
                }
            }
        }

        // ============================================
        // AIRTABLE API FUNCTIONS
        // ============================================

        function setSyncStatus(status) {
            const el = document.getElementById('syncStatus');
            el.className = 'sync-status ' + status;
            if (status === 'connected') {
                el.textContent = 'Connected to Cloud';
            } else if (status === 'syncing') {
                el.textContent = 'Syncing...';
            } else if (status === 'error') {
                el.textContent = 'Connection Error';
            }
        }

        async function fetchProducts() {
            setSyncStatus('syncing');
            try {
                const response = await fetch(AIRTABLE_URL, {
                    headers: {
                        'Authorization': `Bearer ${AIRTABLE_CONFIG.apiKey}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch products');
                }

                const data = await response.json();
                products = data.records.map(record => ({
                    id: record.id,
                    partNumber: record.fields.PartNumber || '',
                    description: record.fields.Description || '',
                    openPO: record.fields.OpenPO || '',
                    boxSize: record.fields.BoxSize || '',
                    casePack: record.fields.CasePack || '',
                    backerStock: record.fields.BackerStock || '',
                    amountNeeded: record.fields.AmountNeeded || '',
                    priority: record.fields.Priority || 'none',
                    sortOrder: record.fields.SortOrder ?? 9999
                }));

                // Sort products by SortOrder field from Airtable
                products.sort((a, b) => a.sortOrder - b.sortOrder);

                setSyncStatus('connected');
                return products;
            } catch (error) {
                console.error('Error fetching products:', error);
                setSyncStatus('error');
                throw error;
            }
        }

        async function createProduct(productData) {
            setSyncStatus('syncing');
            try {
                const response = await fetch(AIRTABLE_URL, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${AIRTABLE_CONFIG.apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        records: [{
                            fields: {
                                PartNumber: productData.partNumber,
                                Description: productData.description,
                                OpenPO: productData.openPO ? parseInt(productData.openPO) : null,
                                BoxSize: productData.boxSize || null,
                                CasePack: productData.casePack ? parseInt(productData.casePack) : null,
                                BackerStock: productData.backerStock ? parseInt(productData.backerStock) : null,
                                AmountNeeded: productData.amountNeeded ? parseInt(productData.amountNeeded) : null,
                                Priority: productData.priority || 'none',
                                SortOrder: products.length
                            }
                        }]
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to create product');
                }

                const data = await response.json();
                setSyncStatus('connected');
                return data.records[0];
            } catch (error) {
                console.error('Error creating product:', error);
                setSyncStatus('error');
                throw error;
            }
        }

        async function updateProduct(recordId, productData) {
            setSyncStatus('syncing');
            try {
                const response = await fetch(AIRTABLE_URL, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${AIRTABLE_CONFIG.apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        records: [{
                            id: recordId,
                            fields: {
                                PartNumber: productData.partNumber,
                                Description: productData.description,
                                OpenPO: productData.openPO ? parseInt(productData.openPO) : null,
                                BoxSize: productData.boxSize || null,
                                CasePack: productData.casePack ? parseInt(productData.casePack) : null,
                                BackerStock: productData.backerStock ? parseInt(productData.backerStock) : null,
                                AmountNeeded: productData.amountNeeded ? parseInt(productData.amountNeeded) : null,
                                Priority: productData.priority || 'none'
                            }
                        }]
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to update product');
                }

                setSyncStatus('connected');
                return await response.json();
            } catch (error) {
                console.error('Error updating product:', error);
                setSyncStatus('error');
                throw error;
            }
        }

        async function deleteProductFromAirtable(recordId) {
            setSyncStatus('syncing');
            try {
                const response = await fetch(`${AIRTABLE_URL}/${recordId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${AIRTABLE_CONFIG.apiKey}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to delete product');
                }

                setSyncStatus('connected');
                return true;
            } catch (error) {
                console.error('Error deleting product:', error);
                setSyncStatus('error');
                throw error;
            }
        }

        async function deleteAllProducts() {
            setSyncStatus('syncing');
            try {
                // Airtable allows max 10 records per delete request
                const recordIds = products.map(p => p.id);

                for (let i = 0; i < recordIds.length; i += 10) {
                    const batch = recordIds.slice(i, i + 10);
                    const params = batch.map(id => `records[]=${id}`).join('&');

                    const response = await fetch(`${AIRTABLE_URL}?${params}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${AIRTABLE_CONFIG.apiKey}`
                        }
                    });

                    if (!response.ok) {
                        throw new Error('Failed to delete products');
                    }
                }

                setSyncStatus('connected');
                return true;
            } catch (error) {
                console.error('Error deleting all products:', error);
                setSyncStatus('error');
                throw error;
            }
        }

        // ============================================
        // PAGE INITIALIZATION
        // ============================================

        window.addEventListener('DOMContentLoaded', async function() {
            loadHistory();
            loadOperatorName();
            renderHistory();

            try {
                await fetchProducts();
                renderProducts();
            } catch (error) {
                document.getElementById('productContainer').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">Error</div>
                        <div>Failed to load products. Please check your connection and refresh.</div>
                    </div>
                `;
            }
        });

        async function refreshData() {
            document.getElementById('productContainer').innerHTML = `
                <div class="loading-state">
                    <div class="loading-spinner"></div>
                    <div>Refreshing products...</div>
                </div>
            `;

            try {
                await fetchProducts();
                renderProducts();
            } catch (error) {
                alert('Failed to refresh data. Please check your connection.');
            }
        }

        // ============================================
        // MODAL FUNCTIONS
        // ============================================

        function openModal() {
            editingProductId = null;
            document.getElementById('modalTitle').textContent = 'Add New Product';
            document.getElementById('submitBtn').textContent = 'Add Product';
            document.getElementById('productModal').style.display = 'block';
            document.getElementById('productForm').reset();
        }

        function openEditModal(id) {
            editingProductId = id;
            const product = products.find(p => p.id === id);

            if (product) {
                document.getElementById('modalTitle').textContent = 'Edit Product';
                document.getElementById('submitBtn').textContent = 'Update Product';
                document.getElementById('partNumber').value = product.partNumber;
                document.getElementById('description').value = product.description;
                document.getElementById('openPO').value = product.openPO;
                document.getElementById('boxSize').value = product.boxSize || '';
                document.getElementById('casePack').value = product.casePack || '';
                document.getElementById('backerStock').value = product.backerStock;
                document.getElementById('amountNeeded').value = product.amountNeeded;
                document.getElementById('priority').value = product.priority || 'none';
                document.getElementById('productModal').style.display = 'block';
            }
        }

        function closeModal() {
            document.getElementById('productModal').style.display = 'none';
        }

        window.onclick = function(event) {
            const productModal = document.getElementById('productModal');
            const inventoryModal = document.getElementById('inventoryModal');
            const shipmentModal = document.getElementById('shipmentModal');
            if (event.target == productModal) {
                closeModal();
            }
            if (event.target == inventoryModal) {
                closeInventoryModal();
            }
            if (event.target == shipmentModal) {
                closeShipmentModal();
            }
        }

        // ============================================
        // FORM HANDLERS
        // ============================================

        document.getElementById('productForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Saving...';

            const productData = {
                partNumber: document.getElementById('partNumber').value,
                description: document.getElementById('description').value,
                openPO: document.getElementById('openPO').value,
                boxSize: document.getElementById('boxSize').value,
                casePack: document.getElementById('casePack').value,
                backerStock: document.getElementById('backerStock').value,
                amountNeeded: document.getElementById('amountNeeded').value,
                priority: document.getElementById('priority').value
            };

            try {
                if (editingProductId) {
                    // Find original product to track changes
                    const originalProduct = products.find(p => p.id === editingProductId);
                    const changes = [];

                    if (originalProduct) {
                        if (originalProduct.partNumber !== productData.partNumber) changes.push(`Part#: ${originalProduct.partNumber} ‚Üí ${productData.partNumber}`);
                        if (originalProduct.description !== productData.description) changes.push(`Description changed`);
                        if (originalProduct.openPO !== productData.openPO) changes.push(`Open PO: ${originalProduct.openPO || '0'} ‚Üí ${productData.openPO || '0'}`);
                        if (originalProduct.boxSize !== productData.boxSize) changes.push(`Box Size: ${originalProduct.boxSize || '-'} ‚Üí ${productData.boxSize || '-'}`);
                        if (originalProduct.casePack !== productData.casePack) changes.push(`Case Pack: ${originalProduct.casePack || '0'} ‚Üí ${productData.casePack || '0'}`);
                        if (originalProduct.backerStock !== productData.backerStock) changes.push(`Backer Stock: ${originalProduct.backerStock || '0'} ‚Üí ${productData.backerStock || '0'}`);
                        if (originalProduct.amountNeeded !== productData.amountNeeded) changes.push(`Amount Needed: ${originalProduct.amountNeeded || '0'} ‚Üí ${productData.amountNeeded || '0'}`);
                        if (originalProduct.priority !== productData.priority) changes.push(`Priority: ${originalProduct.priority || 'none'} ‚Üí ${productData.priority || 'none'}`);
                    }

                    await updateProduct(editingProductId, productData);
                    const changeDetails = changes.length > 0 ? changes.join(' | ') : 'No field changes detected';
                    addHistory('edit', `Edited product: ${productData.partNumber}`, changeDetails);
                } else {
                    await createProduct(productData);
                    const details = `Part#: ${productData.partNumber}, Priority: ${productData.priority || 'none'}`;
                    addHistory('add', `Added new product: ${productData.partNumber}`, details);
                }

                await fetchProducts();
                renderProducts();
                closeModal();
            } catch (error) {
                alert('Failed to save product. Please try again.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = editingProductId ? 'Update Product' : 'Add Product';
            }
        });

        // ============================================
        // RENDER FUNCTIONS
        // ============================================

        function renderProducts() {
            const container = document.getElementById('productContainer');

            if (products.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì¶</div>
                        <div>No products yet. Click "Add New Product" to get started!</div>
                    </div>
                `;
                updateStats();
                return;
            }

            const priorityColors = {
                'critical': '#fc8181',
                'high': '#f6ad55',
                'medium': '#f6e05e',
                'low': '#68d391',
                'none': '#e2e8f0'
            };

            const priorityTextColors = {
                'critical': 'white',
                'high': 'white',
                'medium': '#744210',
                'low': 'white',
                'none': '#4a5568'
            };

            container.innerHTML = products.map((product, index) => {
                const priority = product.priority || 'none';
                const openPO = parseFloat(product.openPO) || 0;
                const backerStock = parseFloat(product.backerStock) || 0;
                const backerStatus = backerStock - openPO;

                let statusClass = 'status-zero';
                let statusDisplay = '-';

                if (product.openPO !== '' || product.backerStock !== '') {
                    statusDisplay = backerStatus.toFixed(0);
                    if (backerStatus < 0) {
                        statusClass = 'status-negative';
                    } else if (backerStatus > 0) {
                        statusClass = 'status-positive';
                    }
                }

                return `
                    <div class="product-row" draggable="true" data-id="${product.id}">
                        <div class="drag-handle">‚†ø</div>
                        <div class="product-field" style="font-weight: bold; text-align: center;">${index + 1}</div>
                        <div class="product-field part-number-cell">
                            <span class="part-number-text" style="background: ${priorityColors[priority]}; color: ${priorityTextColors[priority]};">
                                ${product.partNumber}
                            </span>
                        </div>
                        <div class="product-field" data-label="Description:">${product.description}</div>
                        <div class="product-field" data-label="Priority:">
                            <span class="priority-badge priority-${priority}">${priority}</span>
                        </div>
                        <div class="product-field" data-label="Open PO:">${product.openPO || '-'}</div>
                        <div class="product-field" data-label="Box Size:">${product.boxSize || '-'}</div>
                        <div class="product-field" data-label="Case Pack:">${product.casePack || '-'}</div>
                        <div class="product-field" data-label="Backer Stock:">${product.backerStock || '-'}</div>
                        <div class="product-field" data-label="Backer Status:">
                            <span class="backer-status ${statusClass}">${statusDisplay}</span>
                        </div>
                        <div class="product-field" data-label="Amount Needed:">${product.amountNeeded || '-'}</div>
                        <div class="action-buttons">
                            <button class="edit-btn" onclick="openEditModal('${product.id}')">‚úèÔ∏è Edit</button>
                            <button class="priority-toggle" onclick="cyclePriority('${product.id}')">‚¨ÜÔ∏è</button>
                            <button class="delete-btn" onclick="deleteProduct('${product.id}')">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');

            attachDragHandlers();
            updateStats();
            populateProductDropdowns();
        }

        function updateStats() {
            document.getElementById('totalProducts').textContent = products.length;
            document.getElementById('criticalCount').textContent = products.filter(p => p.priority === 'critical').length;
            document.getElementById('highCount').textContent = products.filter(p => p.priority === 'high').length;

            const totalOpenPO = products.reduce((sum, p) => {
                const val = parseFloat(p.openPO);
                return sum + (isNaN(val) ? 0 : val);
            }, 0);
            document.getElementById('totalOpenPO').textContent = totalOpenPO.toFixed(0);
        }

        function populateProductDropdowns() {
            const inventorySelect = document.getElementById('inventoryProduct');
            const shipmentSelect = document.getElementById('shipmentProduct');

            const options = products.map(p =>
                `<option value="${p.id}">${p.partNumber} - ${p.description}</option>`
            ).join('');

            inventorySelect.innerHTML = '<option value="">-- Select a product --</option>' + options;
            shipmentSelect.innerHTML = '<option value="">-- Select a product --</option>' + options;
        }

        // ============================================
        // DRAG AND DROP
        // ============================================

        function attachDragHandlers() {
            const rows = document.querySelectorAll('.product-row');

            rows.forEach(row => {
                row.addEventListener('dragstart', handleDragStart);
                row.addEventListener('dragover', handleDragOver);
                row.addEventListener('drop', handleDrop);
                row.addEventListener('dragenter', handleDragEnter);
                row.addEventListener('dragleave', handleDragLeave);
                row.addEventListener('dragend', handleDragEnd);
            });
        }

        function handleDragStart(e) {
            draggedElement = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDragEnter(e) {
            if (this !== draggedElement) {
                this.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }

            if (draggedElement !== this) {
                const draggedId = draggedElement.getAttribute('data-id');
                const targetId = this.getAttribute('data-id');

                const draggedIndex = products.findIndex(p => p.id === draggedId);
                const targetIndex = products.findIndex(p => p.id === targetId);

                // Reorder the products array
                const [removed] = products.splice(draggedIndex, 1);
                products.splice(targetIndex, 0, removed);

                renderProducts();

                // Save the new order to Airtable
                saveProductOrderToAirtable();
            }

            return false;
        }

        function handleDragEnd(e) {
            const rows = document.querySelectorAll('.product-row');
            rows.forEach(row => {
                row.classList.remove('dragging');
                row.classList.remove('drag-over');
            });
        }

        // ============================================
        // PRODUCT ACTIONS
        // ============================================

        async function deleteProduct(id) {
            if (confirm('Are you sure you want to delete this product?')) {
                try {
                    await deleteProductFromAirtable(id);
                    const product = products.find(p => p.id === id);
                    addHistory('delete', `Deleted product: ${product.partNumber}`);
                    await fetchProducts();
                    renderProducts();
                } catch (error) {
                    alert('Failed to delete product. Please try again.');
                }
            }
        }

        async function confirmDeleteAll() {
            if (confirm('‚ö†Ô∏è WARNING: This will delete ALL products. This action cannot be undone. Are you sure?')) {
                if (confirm('Are you REALLY sure? This is your last chance!')) {
                    try {
                        await deleteAllProducts();
                        addHistory('delete', 'Deleted all products');
                        products = [];
                        renderProducts();
                    } catch (error) {
                        alert('Failed to delete all products. Please try again.');
                    }
                }
            }
        }

        async function cyclePriority(id) {
            const product = products.find(p => p.id === id);
            if (product) {
                const currentIndex = priorityOrder.indexOf(product.priority || 'none');
                const nextIndex = (currentIndex + 1) % priorityOrder.length;
                const newPriority = priorityOrder[nextIndex];

                try {
                    await updateProduct(id, {
                        ...product,
                        priority: newPriority
                    });
                    addHistory('edit', `Changed priority for ${product.partNumber} to ${newPriority}`);
                    await fetchProducts();
                    renderProducts();
                } catch (error) {
                    alert('Failed to update priority. Please try again.');
                }
            }
        }

        // ============================================
        // HISTORY FUNCTIONS
        // ============================================

        function loadHistory() {
            const savedHistory = localStorage.getItem('inventory_history');
            if (savedHistory) {
                history = JSON.parse(savedHistory);
            }
        }

        function saveHistory() {
            localStorage.setItem('inventory_history', JSON.stringify(history));
        }

        function saveOperatorName(name) {
            localStorage.setItem('operator_name', name);
        }

        function getOperatorName() {
            return localStorage.getItem('operator_name') || 'Unknown';
        }

        function loadOperatorName() {
            const saved = localStorage.getItem('operator_name');
            if (saved) {
                document.getElementById('operatorName').value = saved;
            }
        }

        function addHistory(type, description, details = null) {
            const timestamp = new Date().toLocaleString();
            const operator = getOperatorName();
            history.unshift({ type, description, timestamp, operator, details });

            if (history.length > 50) {
                history = history.slice(0, 50);
            }

            saveHistory();
            renderHistory();
        }

        function renderHistory() {
            const container = document.getElementById('historyContainer');

            if (history.length === 0) {
                container.innerHTML = '<div style="color: #a0aec0; text-align: center;">No recent activity</div>';
                return;
            }

            container.innerHTML = history.map(item => {
                const operatorDisplay = item.operator ? `<span style="color: #667eea; font-weight: 600;">by ${item.operator}</span>` : '';
                const detailsDisplay = item.details ? `<div style="font-size: 11px; color: #718096; margin-top: 4px; padding-left: 10px; border-left: 2px solid #e2e8f0;">${item.details}</div>` : '';
                return `
                    <div class="history-item ${item.type}">
                        <div>${item.description} ${operatorDisplay}</div>
                        ${detailsDisplay}
                        <span class="history-timestamp">${item.timestamp}</span>
                    </div>
                `;
            }).join('');
        }

        // ============================================
        // INVENTORY MODAL
        // ============================================

        function openInventoryModal() {
            document.getElementById('inventoryModal').style.display = 'block';
            document.getElementById('inventoryForm').reset();
            document.getElementById('inventoryDate').valueAsDate = new Date();
        }

        function closeInventoryModal() {
            document.getElementById('inventoryModal').style.display = 'none';
        }

        document.getElementById('inventoryForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const productId = document.getElementById('inventoryProduct').value;
            const quantity = parseInt(document.getElementById('inventoryQuantity').value);
            const date = document.getElementById('inventoryDate').value;

            const product = products.find(p => p.id === productId);
            if (product) {
                const oldBackerStock = parseInt(product.backerStock) || 0;
                const newBackerStock = oldBackerStock + quantity;

                const dateObj = new Date(date);
                const formattedDate = dateObj.toLocaleDateString();

                const historyDetails = `${product.partNumber} - Qty: ${quantity}, Date: ${formattedDate}, Backer Stock: ${oldBackerStock} to ${newBackerStock}`;
                addHistory('inventory', `Received inventory: ${historyDetails}`);

                try {
                    await updateProduct(productId, {
                        ...product,
                        backerStock: newBackerStock.toString()
                    });
                    await fetchProducts();
                    renderProducts();
                    closeInventoryModal();
                } catch (error) {
                    alert('Failed to receive inventory. Please try again.');
                }
            }
        });

        // ============================================
        // SHIPMENT MODAL
        // ============================================

        function openShipmentModal() {
            document.getElementById('shipmentModal').style.display = 'block';
            document.getElementById('shipmentForm').reset();
            document.getElementById('shipmentDate').valueAsDate = new Date();
        }

        function closeShipmentModal() {
            document.getElementById('shipmentModal').style.display = 'none';
        }

        document.getElementById('shipmentForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const productId = document.getElementById('shipmentProduct').value;
            const quantity = parseInt(document.getElementById('shipmentQuantity').value);
            const date = document.getElementById('shipmentDate').value;

            const product = products.find(p => p.id === productId);
            if (product) {
                const oldOpenPO = parseInt(product.openPO) || 0;
                const newOpenPO = Math.max(0, oldOpenPO - quantity);

                const oldBackerStock = parseInt(product.backerStock) || 0;
                const newBackerStock = Math.max(0, oldBackerStock - quantity);

                const dateObj = new Date(date);
                const formattedDate = dateObj.toLocaleDateString();

                const historyDetails = `${product.partNumber} - Qty: ${quantity}, Date: ${formattedDate}, Open PO: ${oldOpenPO} to ${newOpenPO}, Backer Stock: ${oldBackerStock} to ${newBackerStock}`;
                addHistory('shipment', `Shipment processed: ${historyDetails}`);

                try {
                    await updateProduct(productId, {
                        ...product,
                        openPO: newOpenPO.toString(),
                        backerStock: newBackerStock.toString()
                    });
                    await fetchProducts();
                    renderProducts();
                    closeShipmentModal();
                } catch (error) {
                    alert('Failed to process shipment. Please try again.');
                }
            }
        });

        // ============================================
        // PDF GENERATION
        // ============================================

        function generatePDF() {
            const printWindow = window.open('', '_blank');
            const priorityColors = {
                'critical': '#fc8181',
                'high': '#f6ad55',
                'medium': '#f6e05e',
                'low': '#68d391',
                'none': '#e2e8f0'
            };

            const priorityTextColors = {
                'critical': 'white',
                'high': 'white',
                'medium': '#744210',
                'low': 'white',
                'none': '#4a5568'
            };

            const html = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Inventory Tracker - ${new Date().toLocaleDateString()}</title>
                    <style>
                        @media print {
                            @page {
                                size: landscape;
                                margin: 0.5in;
                            }
                        }
                        body {
                            font-family: Arial, sans-serif;
                            padding: 20px;
                        }
                        h1 {
                            color: #667eea;
                            text-align: center;
                            margin-bottom: 10px;
                        }
                        .date {
                            text-align: center;
                            color: #666;
                            margin-bottom: 30px;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-top: 20px;
                        }
                        th {
                            background: #667eea;
                            color: white;
                            padding: 12px;
                            text-align: left;
                            font-weight: 600;
                            border: 1px solid #5568d3;
                        }
                        td {
                            padding: 10px 12px;
                            border: 1px solid #e2e8f0;
                        }
                        tr:nth-child(even) {
                            background: #f7fafc;
                        }
                        .part-number {
                            font-weight: 700;
                            padding: 6px 10px;
                            border-radius: 4px;
                            display: inline-block;
                        }
                        .priority {
                            font-weight: 700;
                            padding: 6px 10px;
                            border-radius: 4px;
                            display: inline-block;
                            text-transform: uppercase;
                        }
                        .backer-status {
                            font-weight: 700;
                            padding: 6px 10px;
                            border-radius: 4px;
                            display: inline-block;
                        }
                        .status-positive {
                            background: #c6f6d5;
                            color: #22543d;
                        }
                        .status-negative {
                            background: #fc8181;
                            color: white;
                        }
                        .status-zero {
                            background: #e2e8f0;
                            color: #4a5568;
                        }
                        .footer {
                            margin-top: 40px;
                            text-align: center;
                            color: #a0aec0;
                            font-size: 12px;
                        }
                    </style>
                </head>
                <body>
                    <h1>Inventory Tracker</h1>
                    <div class="date">Generated: ${new Date().toLocaleString()}</div>
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Part Number</th>
                                <th>Description</th>
                                <th>Priority</th>
                                <th>Open PO</th>
                                <th>Box Size</th>
                                <th>Case Pack</th>
                                <th>Backer Stock</th>
                                <th>Backer Status</th>
                                <th>Amount Needed</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${products.map((product, index) => {
                                const priority = product.priority || 'none';
                                const openPO = parseFloat(product.openPO) || 0;
                                const backerStock = parseFloat(product.backerStock) || 0;
                                const backerStatus = backerStock - openPO;

                                let statusClass = 'status-zero';
                                let statusDisplay = '-';

                                if (product.openPO !== '' || product.backerStock !== '') {
                                    statusDisplay = backerStatus.toFixed(0);
                                    if (backerStatus < 0) {
                                        statusClass = 'status-negative';
                                    } else if (backerStatus > 0) {
                                        statusClass = 'status-positive';
                                    }
                                }

                                return `
                                    <tr>
                                        <td>${index + 1}</td>
                                        <td>
                                            <span class="part-number" style="background: ${priorityColors[priority]}; color: ${priorityTextColors[priority]};">
                                                ${product.partNumber}
                                            </span>
                                        </td>
                                        <td>${product.description}</td>
                                        <td>
                                            <span class="priority" style="background: ${priorityColors[priority]}; color: ${priorityTextColors[priority]};">
                                                ${priority.toUpperCase()}
                                            </span>
                                        </td>
                                        <td>${product.openPO || '-'}</td>
                                        <td>${product.boxSize || '-'}</td>
                                        <td>${product.casePack || '-'}</td>
                                        <td>${product.backerStock || '-'}</td>
                                        <td>
                                            <span class="backer-status ${statusClass}">${statusDisplay}</span>
                                        </td>
                                        <td>${product.amountNeeded || '-'}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                    <div class="footer">
                        Total Products: ${products.length} | Inventory Tracker
                    </div>
                </body>
                </html>
            `;

            printWindow.document.write(html);
            printWindow.document.close();

            setTimeout(() => {
                printWindow.print();
            }, 250);
        }
    </script>
</body>
</html>
